#!/usr/bin/env bash
# Pre-commit hook to prevent large uncompressed JSON files
#
# Install: cp scripts/hooks/pre-commit-check-json .git/hooks/pre-commit
#    or:   ln -sf ../../scripts/hooks/pre-commit-check-json .git/hooks/pre-commit
#
# Can also be run manually: ./scripts/hooks/pre-commit-check-json

set -euo pipefail

# Maximum file size in bytes (50MB)
MAX_SIZE=$((50 * 1024 * 1024))
MAX_SIZE_HUMAN="50MB"

# Patterns for files that should be gzipped
SHOULD_BE_GZIPPED_PATTERNS=(
    "catalog/tracked/.*/scans/.*/semgrep\\.json$"
    "catalog/tracked/.*/scans/.*/trufflehog\\.json$"
    "catalog/tracked/.*/scans/.*/kics\\.json$"
    "catalog/tracked/.*/scans/.*/artifacts\\.json$"
    "scans/.*/semgrep-results/.*\\.json$"
    "scans/.*/trufflehog-results/.*\\.json$"
    "scans/.*/kics-results/.*\\.json$"
    "scans/.*/artifact-results/.*\\.json$"
    "scans/.*/inventory/.*-sbom\\.json$"
)

# Colors
RED='\033[0;31m'
YELLOW='\033[1;33m'
NC='\033[0m'

errors=0
warnings=0

# Check if running in git context
if git rev-parse --git-dir > /dev/null 2>&1; then
    # Get list of staged files
    staged_files=$(git diff --cached --name-only --diff-filter=ACM 2>/dev/null || true)
else
    # Running standalone - check all JSON files
    staged_files=$(find . -name "*.json" -size +10M 2>/dev/null | sed 's|^\./||' || true)
fi

for file in $staged_files; do
    # Skip if file doesn't exist
    [[ -f "$file" ]] || continue

    # Check if this is a pattern that should be gzipped
    should_be_gzipped=false
    for pattern in "${SHOULD_BE_GZIPPED_PATTERNS[@]}"; do
        if echo "$file" | grep -qE "$pattern"; then
            should_be_gzipped=true
            break
        fi
    done

    if [[ "$should_be_gzipped" == true ]]; then
        echo -e "${RED}ERROR:${NC} $file should be gzipped (.json.gz)"
        echo "       Run: gzip -c '$file' > '${file}.gz' && rm '$file'"
        errors=$((errors + 1))
        continue
    fi

    # Check size for any JSON file
    if [[ "$file" == *.json ]]; then
        size=$(stat -f%z "$file" 2>/dev/null || stat -c%s "$file" 2>/dev/null || echo "0")
        if [[ "$size" -gt "$MAX_SIZE" ]]; then
            size_mb=$((size / 1024 / 1024))
            echo -e "${RED}ERROR:${NC} $file is ${size_mb}MB (limit: $MAX_SIZE_HUMAN)"
            echo "       Consider gzipping: gzip -c '$file' > '${file}.gz'"
            errors=$((errors + 1))
        fi
    fi
done

if [[ "$errors" -gt 0 ]]; then
    echo ""
    echo -e "${RED}Commit blocked: $errors file(s) need attention${NC}"
    echo ""
    echo "To compress scan results, run:"
    echo "  ./scripts/migrate-to-gzip.sh --execute"
    exit 1
fi

if [[ "$warnings" -gt 0 ]]; then
    echo ""
    echo -e "${YELLOW}Warning: $warnings file(s) may need attention${NC}"
fi

exit 0
