# Cryptographic Weakness Rule Template
#
# Use for: Weak algorithms, hardcoded keys, insecure random, bad configurations
#
rules:
  - id: CHANGEME-crypto-weakness-type
    languages:
      - python  # Change to target language
    message: |
      CHANGEME: Description of the cryptographic weakness.

      Example: Use of MD5 hash algorithm detected. MD5 is cryptographically
      broken and should not be used for security purposes such as password
      hashing or integrity verification.

      Remediation: CHANGEME - Use SHA-256 or better, use bcrypt for passwords, etc.
    severity: WARNING  # WARNING unless actively exploitable
    metadata:
      cwe: "CWE-XX"  # CWE-327 (weak algo), CWE-321 (hardcoded key), CWE-330 (weak random)
      owasp:
        - "A02:2021-Cryptographic-Failures"
      category: security
      confidence: HIGH
      author: "CHANGEME"
      references:
        - https://cwe.mitre.org/data/definitions/XX.html

    pattern-either:
      # Weak hash algorithms
      - pattern: hashlib.md5(...)
      - pattern: hashlib.sha1(...)
      - pattern: MD5.new(...)
      - pattern: SHA.new(...)

      # Weak symmetric ciphers
      - pattern: DES.new(...)
      - pattern: Blowfish.new(...)
      - pattern: ARC4.new(...)
      - pattern: RC4.new(...)

      # Weak asymmetric key sizes (uncomment and adjust)
      # - pattern: RSA.generate($SIZE, ...)
      #   metavariable-comparison:
      #     metavariable: $SIZE
      #     comparison: $SIZE < 2048

      # Insecure random for crypto (uncomment if needed)
      # - pattern: random.random()
      # - pattern: random.randint(...)
      # - pattern: random.choice(...)

---
# Separate rule for hardcoded secrets (different pattern)
rules:
  - id: CHANGEME-hardcoded-crypto-key
    languages:
      - python
    message: |
      Hardcoded cryptographic key detected. Hardcoded keys can be extracted
      from source code or binaries, compromising the security of encrypted data.

      Remediation: Store keys in environment variables, secrets manager, or HSM.
    severity: ERROR
    metadata:
      cwe: "CWE-321"
      owasp:
        - "A02:2021-Cryptographic-Failures"
      category: security
      confidence: MEDIUM  # May have FPs from example code
      author: "CHANGEME"

    patterns:
      - pattern-either:
          - pattern: $CIPHER.new($KEY, ...)
          - pattern: Fernet($KEY)
          - pattern: hmac.new($KEY, ...)
      - metavariable-pattern:
          metavariable: $KEY
          pattern-either:
            - pattern: "..."  # String literal
            - pattern: b"..."  # Bytes literal
      # Exclude obvious test/example keys
      - pattern-not: $FUNC("test", ...)
      - pattern-not: $FUNC("example", ...)
      - pattern-not: $FUNC(b"test", ...)
      - pattern-not-inside: |
          # Example: ...
