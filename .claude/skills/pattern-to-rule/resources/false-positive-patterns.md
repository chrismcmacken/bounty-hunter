# Common False Positive Patterns

Catalog of common sources of false positives in security rules and how to exclude them. Reference this when writing CVE rules to achieve < 20% FP rate.

---

## Category 1: Test Code

### Symptoms
- Findings in `test/`, `tests/`, `spec/` directories
- Findings in files named `*_test.py`, `*.test.js`, `*Test.java`
- Intentionally vulnerable code for testing

### Solutions

**Path exclusion:**
```yaml
paths:
  exclude:
    - "**/test/**"
    - "**/tests/**"
    - "**/spec/**"
    - "**/__tests__/**"
    - "**/test_*.py"
    - "**/*_test.py"
    - "**/*.test.js"
    - "**/*.test.ts"
    - "**/*.spec.js"
    - "**/*Test.java"
    - "**/fixtures/**"
    - "**/testdata/**"
```

**Pattern exclusion:**
```yaml
patterns:
  - pattern: dangerous($INPUT)
  - pattern-not-inside: |
      def test_...(...):
          ...
  - pattern-not-inside: |
      class Test...:
          ...
  - pattern-not-inside: |
      @pytest.fixture
      def ...():
          ...
```

---

## Category 2: Hardcoded Values

### Symptoms
- String literals flagged as injection
- Constant values flagged as secrets
- Configuration defaults flagged as vulnerabilities

### Solutions

**Exclude string literals:**
```yaml
patterns:
  - pattern: cursor.execute($QUERY)
  - pattern-not: cursor.execute("...")  # Hardcoded string = safe
```

**Exclude constants:**
```yaml
patterns:
  - pattern: dangerous($VAR)
  - pattern-not: dangerous($CONST)
  - metavariable-regex:
      metavariable: $CONST
      regex: "^[A-Z_][A-Z0-9_]*$"  # SCREAMING_SNAKE_CASE = constant
```

**For taint mode:**
```yaml
pattern-sources:
  - pattern: request.args.get(...)
    exact: true  # Only this expression, not string literals within
```

---

## Category 3: Example/Demo Code

### Symptoms
- Findings in documentation examples
- Findings in sample projects
- Intentionally simplified (insecure) demo code

### Solutions

**Path exclusion:**
```yaml
paths:
  exclude:
    - "**/examples/**"
    - "**/example/**"
    - "**/demo/**"
    - "**/demos/**"
    - "**/samples/**"
    - "**/sample/**"
    - "**/docs/**"
    - "**/documentation/**"
    - "**/tutorials/**"
```

---

## Category 4: Vendored/Third-Party Code

### Symptoms
- Findings in node_modules, vendor directories
- Findings in copied library code
- Issues in code you don't maintain

### Solutions

**Path exclusion:**
```yaml
paths:
  exclude:
    - "**/vendor/**"
    - "**/vendors/**"
    - "**/node_modules/**"
    - "**/third_party/**"
    - "**/third-party/**"
    - "**/external/**"
    - "**/lib/**"  # Use cautiously
    - "**/bower_components/**"
```

---

## Category 5: Generated Code

### Symptoms
- Findings in auto-generated files
- Findings in build outputs
- Protocol buffer, GraphQL generated code

### Solutions

**Path exclusion:**
```yaml
paths:
  exclude:
    - "**/*.generated.*"
    - "**/*.gen.*"
    - "**/generated/**"
    - "**/*_generated.go"
    - "**/*.pb.go"
    - "**/*.pb.py"
    - "**/dist/**"
    - "**/build/**"
    - "**/__pycache__/**"
```

**Comment-based exclusion:**
```yaml
patterns:
  - pattern: dangerous($X)
  - pattern-not-inside: |
      # Code generated by ...
      ...
```

---

## Category 6: Safe Wrappers

### Symptoms
- Internal sanitization functions not recognized
- Custom validation helpers not recognized
- ORM methods flagged despite being safe

### Solutions

**Add sanitizers:**
```yaml
pattern-sanitizers:
  # Internal sanitizers
  - pattern: sanitize_input(...)
  - pattern: validate(...)
  - pattern: clean(...)
  - pattern: escape(...)

  # ORM methods (inherently parameterized)
  - pattern: $MODEL.objects.filter(...)
  - pattern: $MODEL.objects.get(...)
  - pattern: $MODEL.objects.create(...)
  - pattern: $QUERY.where(...)
  - pattern: $QUERY.filter(...)
```

**Common safe wrappers by framework:**

**Django:**
```yaml
pattern-sanitizers:
  - pattern: $MODEL.objects.filter(...)
  - pattern: $MODEL.objects.exclude(...)
  - pattern: $MODEL.objects.get(...)
  - pattern: F(...)
  - pattern: Q(...)
```

**SQLAlchemy:**
```yaml
pattern-sanitizers:
  - pattern: $SESSION.query(...).filter(...)
  - pattern: $SESSION.query(...).filter_by(...)
  - pattern: select(...).where(...)
```

**Express.js (with validators):**
```yaml
pattern-sanitizers:
  - pattern: validator.escape(...)
  - pattern: sanitizeHtml(...)
  - pattern: DOMPurify.sanitize(...)
```

---

## Category 7: Admin/Internal Code

### Symptoms
- Admin-only functions flagged
- Internal tooling flagged
- Code not accessible to attackers

### Solutions

**Pattern exclusion:**
```yaml
patterns:
  - pattern: dangerous($INPUT)
  - pattern-not-inside: |
      @admin_required
      def ...():
          ...
  - pattern-not-inside: |
      @staff_member_required
      def ...():
          ...
  - pattern-not-inside: |
      @require_admin
      def ...():
          ...
```

**Path-based (less reliable):**
```yaml
paths:
  exclude:
    - "**/admin/**"
    - "**/internal/**"
    - "**/management/**"
```

---

## Category 8: Framework Auto-Protection

### Symptoms
- Framework auto-escapes but rule doesn't know
- Template engines with auto-escaping
- ORMs with parameterized queries

### Solutions

**Exclude safe contexts:**
```yaml
# Flask - render_template uses auto-escaping
patterns:
  - pattern: dangerous($INPUT)
  - pattern-not-inside: |
      return render_template($TEMPLATE, ...)
```

**Framework-aware sinks:**
```yaml
# Don't flag template variables, only template strings
pattern-sinks:
  - pattern: render_template_string($TPL)  # Dangerous
  # Don't include: render_template($FILE, **context)  # Safe
```

---

## Category 9: Type-Safe Languages

### Symptoms
- False positives from strong typing
- Compiler-checked code flagged
- Type conversions flagged unnecessarily

### Solutions

**Type conversion sanitizers:**
```yaml
pattern-sanitizers:
  - pattern: int(...)
  - pattern: float(...)
  - pattern: bool(...)
  - pattern: str(...)
  - pattern: Integer.parseInt(...)
  - pattern: Long.parseLong(...)
  - pattern: (int) ...
  - pattern: strconv.Atoi(...)
```

---

## Category 10: Dead Code / Unreachable Paths

### Symptoms
- Code behind feature flags
- Deprecated functions
- Code in unreachable branches

### Solutions

**Manual exclusion (limited):**
```yaml
patterns:
  - pattern: dangerous($INPUT)
  - pattern-not-inside: |
      if False:
          ...
  - pattern-not-inside: |
      if DEBUG:  # Assuming DEBUG=False in prod
          ...
```

**Note:** Dead code analysis is limited in Semgrep. Use confidence: MEDIUM for rules that may hit dead code.

---

## Vulnerability-Specific FP Patterns

### SQL Injection FPs

**Common FPs:**
1. Parameterized queries incorrectly flagged
2. ORM usage flagged
3. Constant table/column names in query

**Exclusions:**
```yaml
pattern-sanitizers:
  # Parameterized query syntax
  - pattern: $CURSOR.execute("...", (...))  # Tuple = params
  - pattern: $CURSOR.execute("...", [...])  # List = params
  - pattern: $CURSOR.execute($Q, params=$P)

  # ORMs
  - pattern: $MODEL.objects.raw($Q, [...])  # Django raw with params
```

### Command Injection FPs

**Common FPs:**
1. Commands with hardcoded arguments
2. subprocess with shell=False (safe)
3. Commands built from constants

**Exclusions:**
```yaml
patterns:
  - pattern: subprocess.call($CMD, shell=True, ...)
  - pattern-not: subprocess.call($CMD, shell=False, ...)  # Safe
  - pattern-not: subprocess.call([...], ...)  # List = safe (no shell)
```

### Path Traversal FPs

**Common FPs:**
1. os.path.join with validated paths
2. Paths relative to safe base directory
3. Static file serving from fixed directory

**Exclusions:**
```yaml
pattern-sanitizers:
  - pattern: os.path.basename(...)
  - pattern: os.path.realpath(...)
  - pattern: secure_filename(...)
  - pattern: werkzeug.utils.secure_filename(...)
```

### XSS FPs

**Common FPs:**
1. Template engines with auto-escaping
2. Content-Type: application/json responses
3. Internal admin pages

**Exclusions:**
```yaml
pattern-sanitizers:
  - pattern: html.escape(...)
  - pattern: markupsafe.escape(...)
  - pattern: Markup.escape(...)
  - pattern: bleach.clean(...)
  - pattern: DOMPurify.sanitize(...)
  - pattern: xss(...)
```

---

## FP Rate Targets

| Rule Confidence | Target FP Rate | Use Case |
|-----------------|---------------|----------|
| HIGH | < 5% | Blocking in CI |
| MEDIUM | < 20% | PR comments |
| LOW | < 40% | Security audit |

**Measuring FP rate:**
```bash
# Get findings
semgrep --config rule.yaml target/ --json > findings.json

# Sample 20 random findings for manual review
jq -r '.results | .[] | "\(.path):\(.start.line)"' findings.json | shuf | head -20

# Count true vs false positives manually
# FP Rate = False Positives / Total Findings
```

---

## Exclusion Pattern Templates

### Conservative (Minimize FPs)
```yaml
paths:
  exclude:
    - "**/test*/**"
    - "**/spec/**"
    - "**/vendor/**"
    - "**/node_modules/**"
    - "**/examples/**"
    - "**/docs/**"
    - "**/*.test.*"
    - "**/*_test.*"
```

### Aggressive (Maximum Coverage)
```yaml
# Only exclude obvious non-production code
paths:
  exclude:
    - "**/test/**"
    - "**/node_modules/**"
```

### CVE-Specific (Balanced)
```yaml
# Start conservative, remove exclusions as needed
paths:
  exclude:
    - "**/test/**"
    - "**/vendor/**"
    - "**/examples/**"
```
