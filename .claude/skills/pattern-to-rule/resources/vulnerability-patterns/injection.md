# Injection Vulnerabilities Pattern Guide

Reference for writing Semgrep rules detecting injection vulnerabilities (SQL, Command, Template, etc.).

---

## Overview

Injection occurs when untrusted data is sent to an interpreter as part of a command or query. The key pattern is:

```
User Input → Interpreter/Dangerous Function → Execution
```

**CWEs:**
- CWE-78: OS Command Injection
- CWE-89: SQL Injection
- CWE-94: Code Injection (eval)
- CWE-90: LDAP Injection
- CWE-643: XPath Injection

---

## SQL Injection (CWE-89)

### Dangerous Sinks

**Python:**
```yaml
pattern-sinks:
  # sqlite3
  - pattern: $CURSOR.execute($Q)
  - pattern: $CURSOR.executemany($Q, ...)
  - pattern: $CURSOR.executescript($Q)

  # psycopg2, mysql-connector, etc.
  - pattern: $CONN.execute($Q)

  # SQLAlchemy raw
  - pattern: $SESSION.execute(text($Q))
  - pattern: $ENGINE.execute($Q)

  # Django raw
  - pattern: $MODEL.objects.raw($Q)
  - pattern: connection.cursor().execute($Q)
```

**Java:**
```yaml
pattern-sinks:
  - pattern: $STMT.execute($Q)
  - pattern: $STMT.executeQuery($Q)
  - pattern: $STMT.executeUpdate($Q)
  - pattern: $CONN.createStatement().execute($Q)
```

**JavaScript/Node.js:**
```yaml
pattern-sinks:
  # mysql, mysql2
  - pattern: $CONN.query($Q, ...)
  - pattern: $POOL.query($Q, ...)

  # pg (postgres)
  - pattern: $CLIENT.query($Q)

  # Sequelize raw
  - pattern: $SEQ.query($Q, ...)
```

### Sanitizers (Safe Patterns)

```yaml
pattern-sanitizers:
  # Parameterized queries
  - pattern: $CURSOR.execute("...", (...))  # Tuple = params
  - pattern: $CURSOR.execute("...", [...])  # List = params
  - pattern: $CURSOR.execute($Q, $PARAMS)

  # ORMs
  - pattern: $MODEL.objects.filter(...)
  - pattern: $MODEL.objects.get(...)
  - pattern: $QUERY.where($FIELD, $VALUE)

  # Type conversions
  - pattern: int(...)
  - pattern: uuid.UUID(...)
```

### Example Rule

```yaml
rules:
  - id: python-sql-injection
    mode: taint
    languages: [python]
    severity: ERROR
    message: |
      SQL injection via string concatenation. Use parameterized queries.
    pattern-sources:
      - pattern: request.args.get(...)
      - pattern: request.form[...]
    pattern-sinks:
      - pattern: $CURSOR.execute($Q)
        focus-metavariable: $Q
    pattern-sanitizers:
      - pattern: $CURSOR.execute("...", (...))
      - pattern: int(...)
```

---

## Command Injection (CWE-78)

### Dangerous Sinks

**Python:**
```yaml
pattern-sinks:
  # Direct shell execution
  - pattern: os.system($CMD)
  - pattern: os.popen($CMD)

  # subprocess with shell=True
  - pattern: subprocess.call($CMD, shell=True, ...)
  - pattern: subprocess.run($CMD, shell=True, ...)
  - pattern: subprocess.Popen($CMD, shell=True, ...)
  - pattern: subprocess.check_output($CMD, shell=True, ...)
```

**Java:**
```yaml
pattern-sinks:
  - pattern: Runtime.getRuntime().exec($CMD)
  - pattern: new ProcessBuilder($CMD).start()
```

**JavaScript/Node.js:**
```yaml
pattern-sinks:
  - pattern: child_process.exec($CMD, ...)
  - pattern: child_process.execSync($CMD, ...)
  - pattern: child_process.spawn($CMD, ..., {shell: true})
```

**PHP:**
```yaml
pattern-sinks:
  - pattern: exec($CMD, ...)
  - pattern: shell_exec($CMD)
  - pattern: system($CMD)
  - pattern: passthru($CMD)
  - pattern: popen($CMD, ...)
  - pattern: proc_open($CMD, ...)
  - pattern: "`$CMD`"  # Backtick execution
```

### Sanitizers

```yaml
pattern-sanitizers:
  # Python
  - pattern: shlex.quote(...)
  - pattern: shlex.split(...)

  # PHP
  - pattern: escapeshellarg(...)
  - pattern: escapeshellcmd(...)
```

### Safe Alternatives (Not Sinks)

```yaml
# subprocess with list args (no shell)
- pattern: subprocess.run([...], ...)  # List = safe
- pattern: subprocess.call([...], ...)
- pattern: subprocess.Popen([...], ...)
```

---

## Code Injection (CWE-94)

### Dangerous Sinks

**Python:**
```yaml
pattern-sinks:
  - pattern: eval($CODE)
  - pattern: exec($CODE)
  - pattern: compile($CODE, ...)
  - pattern: __import__($MODULE)
  - pattern: importlib.import_module($MODULE)
```

**JavaScript:**
```yaml
pattern-sinks:
  - pattern: eval($CODE)
  - pattern: new Function($CODE)
  - pattern: setTimeout($CODE, ...)  # If string
  - pattern: setInterval($CODE, ...)  # If string
```

**PHP:**
```yaml
pattern-sinks:
  - pattern: eval($CODE)
  - pattern: assert($CODE)
  - pattern: preg_replace($PATTERN, $REPLACEMENT, ..., "e")  # /e modifier
  - pattern: create_function($ARGS, $CODE)
```

### Sanitizers

```yaml
pattern-sanitizers:
  # Generally no safe sanitizers for eval
  # Exclude hardcoded strings only
  - pattern: eval("...")
```

---

## LDAP Injection (CWE-90)

### Dangerous Sinks

**Python:**
```yaml
pattern-sinks:
  - pattern: $CONN.search_s($BASE, $SCOPE, $FILTER)
  - pattern: $CONN.search($BASE, $SCOPE, $FILTER)
```

**Java:**
```yaml
pattern-sinks:
  - pattern: $CTX.search($NAME, $FILTER, ...)
  - pattern: new InitialDirContext(...).search($NAME, $FILTER, ...)
```

### Sanitizers

```yaml
pattern-sanitizers:
  - pattern: ldap.filter.escape_filter_chars(...)
  - pattern: ldap3.utils.conv.escape_filter_chars(...)
```

---

## Detection Patterns by String Construction

### String Concatenation
```yaml
# Python
- pattern: $SINK("..." + $VAR + "...")
- pattern: $SINK($VAR + "...")

# Java
- pattern: $SINK("..." + $VAR)
- pattern: $SINK(new StringBuilder().append($VAR).toString())

# JavaScript
- pattern: $SINK("..." + $VAR)
```

### Format Strings
```yaml
# Python f-strings
- pattern: $SINK(f"...{$VAR}...")

# Python .format()
- pattern: $SINK("...{}...".format($VAR))
- pattern: $SINK("...{name}...".format(name=$VAR))

# Python % formatting
- pattern: $SINK("...%s..." % $VAR)
```

### Template Literals (JavaScript)
```yaml
- pattern: $SINK(`...${$VAR}...`)
```

---

## Common Variants

### Indirect Injection (Variable Assignment)
```yaml
# Variable holds the malicious value
- pattern: |
    $QUERY = "..." + $INPUT + "..."
    ...
    $SINK($QUERY)
```

### Multi-Step (Taint Mode Required)
```yaml
# Input flows through transformations
mode: taint
pattern-sources:
  - pattern: request.args.get(...)
pattern-sinks:
  - pattern: cursor.execute($Q)
```

### Partial Injection
```yaml
# Only part of string is user-controlled
- pattern: $SINK("SELECT * FROM " + $TABLE)  # Table name injection
- pattern: $SINK("ORDER BY " + $COLUMN)       # Column name injection
```

---

## Test Case Template

```python
# test_injection.py

# === TRUE POSITIVES ===

# ruleid: sql-injection
def bad_concat():
    user_id = request.args.get('id')
    cursor.execute("SELECT * FROM users WHERE id = " + user_id)

# ruleid: sql-injection
def bad_fstring():
    user_id = request.args.get('id')
    cursor.execute(f"SELECT * FROM users WHERE id = {user_id}")

# ruleid: sql-injection
def bad_format():
    user_id = request.args.get('id')
    cursor.execute("SELECT * FROM users WHERE id = {}".format(user_id))

# === TRUE NEGATIVES ===

# ok: sql-injection
def good_parameterized():
    user_id = request.args.get('id')
    cursor.execute("SELECT * FROM users WHERE id = ?", (user_id,))

# ok: sql-injection
def good_hardcoded():
    cursor.execute("SELECT * FROM users WHERE id = 1")

# ok: sql-injection
def good_type_cast():
    user_id = int(request.args.get('id'))
    cursor.execute(f"SELECT * FROM users WHERE id = {user_id}")
```
