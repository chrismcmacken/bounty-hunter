# Deserialization Vulnerabilities Pattern Guide

Reference for writing Semgrep rules detecting insecure deserialization (CWE-502).

---

## Overview

Insecure deserialization occurs when untrusted data is deserialized without validation, potentially leading to remote code execution.

**CWE:** CWE-502 - Deserialization of Untrusted Data

**Impact:**
- Remote Code Execution (RCE)
- Object injection
- Denial of Service
- Authentication bypass

---

## Python Deserialization

### Pickle (Most Dangerous)

**Sinks:**
```yaml
pattern-sinks:
  # Standard pickle
  - pattern: pickle.load($FILE)
  - pattern: pickle.loads($DATA)
  - pattern: cPickle.load($FILE)
  - pattern: cPickle.loads($DATA)

  # Shelve (uses pickle internally)
  - pattern: shelve.open($FILE)

  # Joblib (ML models)
  - pattern: joblib.load($FILE)

  # PyTorch
  - pattern: torch.load($FILE)
  - pattern: torch.load($FILE, ...)

  # Dill (extended pickle)
  - pattern: dill.load($FILE)
  - pattern: dill.loads($DATA)
```

**ML-Specific Sinks:**
```yaml
# Sklearn
- pattern: sklearn.externals.joblib.load($FILE)
- pattern: load($FILE)  # From joblib import

# Keras/TensorFlow
- pattern: keras.models.load_model($FILE)  # Can load pickle
- pattern: tf.keras.models.load_model($FILE)

# NumPy (allows pickle by default)
- pattern: numpy.load($FILE, allow_pickle=True)
- pattern: np.load($FILE, allow_pickle=True)
```

**Sanitizers:**
```yaml
pattern-sanitizers:
  # Restricted unpickler (if implemented correctly)
  - pattern: RestrictedUnpickler(...).load()

  # NumPy with pickle disabled
  - pattern: numpy.load($FILE, allow_pickle=False)
```

### YAML (Unsafe Load)

**Sinks:**
```yaml
pattern-sinks:
  # PyYAML unsafe
  - pattern: yaml.load($DATA)  # No Loader = unsafe
  - pattern: yaml.load($DATA, Loader=yaml.Loader)
  - pattern: yaml.load($DATA, Loader=yaml.UnsafeLoader)
  - pattern: yaml.load($DATA, Loader=yaml.FullLoader)  # Can be unsafe
  - pattern: yaml.unsafe_load($DATA)

  # ruamel.yaml
  - pattern: ruamel.yaml.load($DATA)
```

**Sanitizers:**
```yaml
pattern-sanitizers:
  - pattern: yaml.safe_load($DATA)
  - pattern: yaml.load($DATA, Loader=yaml.SafeLoader)
  - pattern: yaml.load($DATA, Loader=yaml.BaseLoader)
```

---

## Java Deserialization

### ObjectInputStream (Most Common)

**Sinks:**
```yaml
pattern-sinks:
  # Standard ObjectInputStream
  - pattern: new ObjectInputStream($STREAM).readObject()
  - pattern: $OIS.readObject()
  - pattern: $OIS.readUnshared()

  # XMLDecoder (also dangerous)
  - pattern: new XMLDecoder($STREAM).readObject()
  - pattern: $XD.readObject()
```

**Framework-Specific Sinks:**
```yaml
# Spring
- pattern: new SerializationDelegate(...).deserialize($DATA)

# Hessian
- pattern: new HessianInput($STREAM).readObject()
- pattern: new BurlapInput($STREAM).readObject()

# XStream
- pattern: new XStream().fromXML($DATA)
- pattern: $XSTREAM.fromXML($DATA)

# SnakeYAML
- pattern: new Yaml().load($DATA)
- pattern: $YAML.load($DATA)
```

**Sanitizers:**
```yaml
pattern-sanitizers:
  # ObjectInputFilter (Java 9+)
  - pattern: |
      ObjectInputFilter.Config.setSerialFilter(...)
      ...
      $OIS.readObject()

  # ValidatingObjectInputStream (Apache Commons)
  - pattern: new ValidatingObjectInputStream($STREAM)

  # Look-ahead deserialization
  - pattern: new LookAheadObjectInputStream($STREAM)
```

---

## Ruby Deserialization

### Marshal

**Sinks:**
```yaml
pattern-sinks:
  - pattern: Marshal.load($DATA)
  - pattern: Marshal.restore($DATA)
```

### YAML

**Sinks:**
```yaml
pattern-sinks:
  - pattern: YAML.load($DATA)
  - pattern: Psych.load($DATA)
  - pattern: YAML.unsafe_load($DATA)
```

**Sanitizers:**
```yaml
pattern-sanitizers:
  - pattern: YAML.safe_load($DATA)
  - pattern: Psych.safe_load($DATA)
  - pattern: YAML.load($DATA, permitted_classes: [...])
```

---

## PHP Deserialization

### unserialize

**Sinks:**
```yaml
pattern-sinks:
  - pattern: unserialize($DATA)
  - pattern: unserialize($DATA, [...])  # Even with allowed_classes
```

**Sanitizers:**
```yaml
pattern-sanitizers:
  # Restrict to specific classes
  - pattern: unserialize($DATA, ['allowed_classes' => false])
  - pattern: unserialize($DATA, ['allowed_classes' => ['SafeClass']])
```

---

## .NET Deserialization

### BinaryFormatter (Most Dangerous)

**Sinks:**
```yaml
pattern-sinks:
  - pattern: new BinaryFormatter().Deserialize($STREAM)
  - pattern: $BF.Deserialize($STREAM)

  # Also dangerous
  - pattern: new NetDataContractSerializer().ReadObject($STREAM)
  - pattern: new SoapFormatter().Deserialize($STREAM)
  - pattern: new ObjectStateFormatter().Deserialize($DATA)
  - pattern: new LosFormatter().Deserialize($DATA)
```

**JSON.NET (Can Be Dangerous):**
```yaml
pattern-sinks:
  # Dangerous with TypeNameHandling
  - pattern: |
      JsonConvert.DeserializeObject($DATA, new JsonSerializerSettings
      {
          TypeNameHandling = TypeNameHandling.$TYPE
      })
```

**Sanitizers:**
```yaml
pattern-sanitizers:
  - pattern: |
      JsonConvert.DeserializeObject($DATA, new JsonSerializerSettings
      {
          TypeNameHandling = TypeNameHandling.None
      })
```

---

## Node.js Deserialization

### node-serialize (Known Vulnerable)

**Sinks:**
```yaml
pattern-sinks:
  - pattern: serialize.unserialize($DATA)
  - pattern: require('node-serialize').unserialize($DATA)
```

### js-yaml

**Sinks:**
```yaml
pattern-sinks:
  - pattern: yaml.load($DATA)  # Deprecated, was unsafe
  - pattern: yaml.safeLoad($DATA)  # Old API
```

---

## Taint Mode Pattern

```yaml
rules:
  - id: insecure-deserialization
    mode: taint
    languages: [python]
    severity: CRITICAL
    message: |
      User-controlled data passed to pickle.loads() can lead to RCE.
      Use safe serialization formats like JSON instead.
    metadata:
      cwe: "CWE-502"
      confidence: HIGH

    pattern-sources:
      # Web input
      - pattern: request.get_data()
      - pattern: request.data
      - pattern: request.files[$NAME].read()
      # File input
      - pattern: open($FILE, "rb").read()

    pattern-sinks:
      - pattern: pickle.loads($DATA)
      - pattern: pickle.load($FILE)

    pattern-sanitizers:
      # There are no safe sanitizers for pickle
      # Only exclude hardcoded/constant data
      - pattern: pickle.loads(b"...")
```

---

## Test Case Template

```python
# test_deserialization.py

import pickle
from flask import request

# === TRUE POSITIVES ===

# ruleid: insecure-deserialization
def bad_pickle_loads():
    data = request.get_data()
    obj = pickle.loads(data)
    return obj

# ruleid: insecure-deserialization
def bad_pickle_file():
    filename = request.args.get('file')
    with open(filename, 'rb') as f:
        obj = pickle.load(f)
    return obj

# ruleid: insecure-deserialization
def bad_yaml_load():
    data = request.get_data()
    obj = yaml.load(data)  # No Loader specified
    return obj

# === TRUE NEGATIVES ===

# ok: insecure-deserialization
def good_json():
    data = request.get_data()
    obj = json.loads(data)  # JSON is safe
    return obj

# ok: insecure-deserialization
def good_yaml_safe():
    data = request.get_data()
    obj = yaml.safe_load(data)
    return obj

# ok: insecure-deserialization
def good_hardcoded():
    data = b'\x80\x03}q\x00.'  # Hardcoded pickle data
    obj = pickle.loads(data)
    return obj
```

---

## Common CVE Patterns

### CVE Pattern: Gadget Chains

Many deserialization CVEs involve "gadget chains" - sequences of method calls triggered during deserialization:

```
Deserialize → __reduce__ → os.system("malicious command")
```

**Detection Focus:**
- Detect the deserialization sink
- Payload construction is attacker's problem
- Rule should flag ANY untrusted deserialization

### CVE Pattern: Nested/Indirect Deserialization

```python
# JSON containing base64-encoded pickle
data = json.loads(request.data)
obj = pickle.loads(base64.b64decode(data['payload']))
```

**Taint mode required** to track through transformations.

### CVE Pattern: Model Loading

```python
# ML model files often contain pickle
model = joblib.load(user_uploaded_file)  # RCE via malicious model
```

**High-value targets:**
- Machine learning applications
- Plugin/extension systems
- Configuration loaders
