# Path Traversal Vulnerabilities Pattern Guide

Reference for writing Semgrep rules detecting path traversal (CWE-22).

---

## Overview

Path traversal allows attackers to access files outside intended directories using sequences like `../` or absolute paths.

**CWE:** CWE-22 - Improper Limitation of a Pathname to a Restricted Directory

**Impact:**
- Read sensitive files (/etc/passwd, source code, configs)
- Write malicious files (web shells, cron jobs)
- Delete critical files
- Information disclosure

---

## Common Attack Patterns

### Relative Path Traversal
```
../../../etc/passwd
..%2F..%2F..%2Fetc%2Fpasswd  (URL encoded)
....//....//....//etc/passwd (filter bypass)
..%252f..%252f..%252fetc%252fpasswd (double encoding)
```

### Absolute Path Injection
```
/etc/passwd
C:\Windows\System32\config\SAM
file:///etc/passwd
```

### Null Byte Injection (Legacy)
```
../../../etc/passwd%00.jpg  (worked in older systems)
```

---

## Python Path Traversal

### File Operations (Sinks)

```yaml
pattern-sinks:
  # Open/read
  - pattern: open($PATH, ...)
  - pattern: io.open($PATH, ...)

  # Path operations
  - pattern: os.path.join($BASE, $PATH)  # Can be bypassed!
  - pattern: pathlib.Path($PATH)

  # File system operations
  - pattern: os.listdir($PATH)
  - pattern: os.remove($PATH)
  - pattern: os.unlink($PATH)
  - pattern: os.rename($OLD, $NEW)
  - pattern: os.mkdir($PATH)
  - pattern: os.makedirs($PATH)
  - pattern: shutil.copy($SRC, $DST)
  - pattern: shutil.move($SRC, $DST)
  - pattern: shutil.rmtree($PATH)

  # Send file (Flask)
  - pattern: send_file($PATH)
  - pattern: send_from_directory($DIR, $FILENAME)
```

### os.path.join Bypass (Critical!)

**The vulnerability:** `os.path.join()` ignores previous components if a later component is absolute:

```python
# VULNERABLE: User provides absolute path
os.path.join("/safe/dir", "/etc/passwd")  # Returns "/etc/passwd"
os.path.join("/safe/dir", user_input)     # If user_input="/etc/passwd", bypassed!
```

**Detection pattern:**
```yaml
patterns:
  - pattern: os.path.join($BASE, $USER_INPUT)
  - metavariable-pattern:
      metavariable: $USER_INPUT
      patterns:
        - pattern-not: "..."  # Exclude hardcoded strings
```

### Sanitizers

```yaml
pattern-sanitizers:
  # Basename (removes directory components)
  - pattern: os.path.basename($PATH)

  # Secure filename (Flask/Werkzeug)
  - pattern: secure_filename($PATH)
  - pattern: werkzeug.utils.secure_filename($PATH)

  # Realpath + startswith check
  - pattern: |
      $REAL = os.path.realpath($PATH)
      if $REAL.startswith($ALLOWED):
          ...

  # Path validation
  - pattern: |
      if ".." in $PATH:
          raise ...
```

---

## Java Path Traversal

### File Operations (Sinks)

```yaml
pattern-sinks:
  # File class
  - pattern: new File($PATH)
  - pattern: new FileInputStream($PATH)
  - pattern: new FileOutputStream($PATH)
  - pattern: new FileReader($PATH)
  - pattern: new FileWriter($PATH)

  # NIO
  - pattern: Paths.get($PATH)
  - pattern: Files.readAllBytes(Paths.get($PATH))
  - pattern: Files.write(Paths.get($PATH), ...)
  - pattern: Files.delete(Paths.get($PATH))

  # Spring
  - pattern: new ClassPathResource($PATH)
  - pattern: resourceLoader.getResource($PATH)
```

### Sanitizers

```yaml
pattern-sanitizers:
  # getCanonicalPath + check
  - pattern: |
      $FILE.getCanonicalPath().startsWith($ALLOWED)

  # Path normalization
  - pattern: FilenameUtils.normalize($PATH)
  - pattern: Paths.get($PATH).normalize()

  # Spring security
  - pattern: |
      if ($PATH.contains("..")) {
          ...
      }
```

---

## JavaScript/Node.js Path Traversal

### File Operations (Sinks)

```yaml
pattern-sinks:
  # fs module
  - pattern: fs.readFile($PATH, ...)
  - pattern: fs.readFileSync($PATH, ...)
  - pattern: fs.writeFile($PATH, ...)
  - pattern: fs.writeFileSync($PATH, ...)
  - pattern: fs.unlink($PATH, ...)
  - pattern: fs.unlinkSync($PATH)
  - pattern: fs.createReadStream($PATH)
  - pattern: fs.createWriteStream($PATH)

  # Express static file serving
  - pattern: res.sendFile($PATH)
  - pattern: res.download($PATH)

  # Path construction
  - pattern: path.join($BASE, $PATH)  # Can be bypassed with absolute path
  - pattern: path.resolve($BASE, $PATH)
```

### Sanitizers

```yaml
pattern-sanitizers:
  # path.basename
  - pattern: path.basename($PATH)

  # Normalize + check
  - pattern: |
      $SAFE = path.normalize($PATH)
      if ($SAFE.startsWith($ALLOWED)) { ... }

  # Resolve + check
  - pattern: |
      $RESOLVED = path.resolve($BASE, $PATH)
      if (!$RESOLVED.startsWith($BASE)) { throw ... }
```

---

## PHP Path Traversal

### File Operations (Sinks)

```yaml
pattern-sinks:
  - pattern: file_get_contents($PATH)
  - pattern: file_put_contents($PATH, ...)
  - pattern: fopen($PATH, ...)
  - pattern: include($PATH)
  - pattern: include_once($PATH)
  - pattern: require($PATH)
  - pattern: require_once($PATH)
  - pattern: readfile($PATH)
  - pattern: unlink($PATH)
  - pattern: copy($SRC, $DST)
  - pattern: rename($OLD, $NEW)
```

### Sanitizers

```yaml
pattern-sanitizers:
  - pattern: basename($PATH)
  - pattern: realpath($PATH)
```

---

## Go Path Traversal

### File Operations (Sinks)

```yaml
pattern-sinks:
  - pattern: os.Open($PATH)
  - pattern: os.Create($PATH)
  - pattern: os.ReadFile($PATH)
  - pattern: os.WriteFile($PATH, ...)
  - pattern: ioutil.ReadFile($PATH)
  - pattern: ioutil.WriteFile($PATH, ...)
  - pattern: http.ServeFile($W, $R, $PATH)
  - pattern: http.FileServer(http.Dir($PATH))
```

### Sanitizers

```yaml
pattern-sanitizers:
  - pattern: filepath.Base($PATH)
  - pattern: filepath.Clean($PATH)
  - pattern: |
      if strings.Contains($PATH, "..") { ... }
```

---

## Taint Mode Pattern

```yaml
rules:
  - id: path-traversal
    mode: taint
    languages: [python]
    severity: ERROR
    message: |
      User input used in file path without validation.
      Use os.path.basename() or validate against allowed directory.
    metadata:
      cwe: "CWE-22"
      confidence: HIGH

    pattern-sources:
      - pattern: request.args.get(...)
      - pattern: request.form[...]
      - pattern: request.json[...]

    pattern-sinks:
      - pattern: open($PATH, ...)
        focus-metavariable: $PATH
      - pattern: send_file($PATH)
        focus-metavariable: $PATH

    pattern-sanitizers:
      - pattern: os.path.basename(...)
      - pattern: secure_filename(...)
      - pattern: |
          if ".." in $PATH:
              ...
```

---

## False Positive Considerations

### Safe Patterns to Exclude

```yaml
patterns:
  - pattern: open($PATH, ...)
  # Exclude hardcoded paths
  - pattern-not: open("...", ...)
  # Exclude constant paths
  - pattern-not: open($CONST, ...)
  - metavariable-regex:
      metavariable: $CONST
      regex: "^[A-Z_][A-Z0-9_]*$"
```

### os.path.join with Constant Base

```yaml
# This is safe if base is constant and result is validated
- pattern-not: |
    $PATH = os.path.join("/constant/path", $VAR)
    $REAL = os.path.realpath($PATH)
    if $REAL.startswith("/constant/path"):
        ...
```

---

## Test Case Template

```python
# test_path_traversal.py

import os
from flask import request, send_file
from werkzeug.utils import secure_filename

# === TRUE POSITIVES ===

# ruleid: path-traversal
def bad_open():
    filename = request.args.get('file')
    with open(filename, 'r') as f:
        return f.read()

# ruleid: path-traversal
def bad_path_join():
    filename = request.args.get('file')
    path = os.path.join('/uploads', filename)  # Bypassed with absolute path!
    return send_file(path)

# ruleid: path-traversal
def bad_path_concat():
    filename = request.args.get('file')
    path = '/uploads/' + filename
    return send_file(path)

# === TRUE NEGATIVES ===

# ok: path-traversal
def good_basename():
    filename = request.args.get('file')
    safe_name = os.path.basename(filename)  # Removes path components
    path = os.path.join('/uploads', safe_name)
    return send_file(path)

# ok: path-traversal
def good_secure_filename():
    filename = request.args.get('file')
    safe_name = secure_filename(filename)
    path = os.path.join('/uploads', safe_name)
    return send_file(path)

# ok: path-traversal
def good_realpath_check():
    filename = request.args.get('file')
    path = os.path.join('/uploads', filename)
    real_path = os.path.realpath(path)
    if not real_path.startswith('/uploads'):
        raise ValueError("Path traversal attempt")
    return send_file(real_path)

# ok: path-traversal
def good_hardcoded():
    with open('/etc/app/config.json', 'r') as f:
        return f.read()
```

---

## Common CVE Patterns

### CVE Pattern: Archive Extraction (Zip Slip)

```python
# Vulnerable: extracting without path validation
with zipfile.ZipFile(uploaded_file) as z:
    z.extractall(destination)  # Malicious archive can write outside!
```

**Detection:**
```yaml
pattern-sinks:
  - pattern: $ZIP.extractall(...)
  - pattern: $ZIP.extract($MEMBER, ...)
  - pattern: $TAR.extractall(...)
  - pattern: $TAR.extract($MEMBER, ...)
```

### CVE Pattern: URL Path Parameters

```python
# Flask route with path parameter
@app.route('/files/<path:filename>')
def serve_file(filename):
    return send_file(f'/data/{filename}')  # ../../../etc/passwd
```

**Detection:**
```yaml
patterns:
  - pattern: |
      @app.route(".../<path:$PARAM>")
      def $FUNC($PARAM):
          ...
          send_file(...$PARAM...)
```
