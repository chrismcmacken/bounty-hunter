# CVE Rule Workflow Implementation Plan

This document tracks the implementation of enhanced CVE-to-Semgrep rule skills and documentation.

## Overview

Enhance the CVE rule workflow with:
1. Full Semgrep documentation locally available to skills
2. `cve-to-rule` skill for CVE analysis and rule generation
3. `test-semgrep-rule` skill for rule evaluation against known-vulnerable repos
4. Updated workflow document with research-backed recommendations

---

## Phase 1: Semgrep Documentation

Create full and summarized Semgrep documentation for skill consumption.

### Files to Create

| File | Status | Description |
|------|--------|-------------|
| `.claude/skills/cve-to-rule/resources/semgrep-docs/rule-syntax.md` | DONE | Full rule syntax reference |
| `.claude/skills/cve-to-rule/resources/semgrep-docs/pattern-syntax.md` | DONE | Pattern matching operators |
| `.claude/skills/cve-to-rule/resources/semgrep-docs/taint-mode.md` | DONE | Taint analysis documentation |
| `.claude/skills/cve-to-rule/resources/semgrep-docs/testing-rules.md` | DONE | Rule testing with annotations |
| `.claude/skills/cve-to-rule/resources/semgrep-docs/reducing-false-positives.md` | DONE | FP reduction techniques |
| `.claude/skills/cve-to-rule/resources/semgrep-reference.md` | DONE | **Summarized quick reference with links to full docs** |

### Source URLs
- Rule Syntax: https://semgrep.dev/docs/writing-rules/rule-syntax
- Pattern Syntax: https://semgrep.dev/docs/writing-rules/pattern-syntax
- Taint Mode: https://semgrep.dev/docs/writing-rules/data-flow/taint-mode/overview
- Testing: https://semgrep.dev/docs/writing-rules/testing-rules
- FP Reduction: https://semgrep.dev/docs/kb/semgrep-code/reduce-false-positives

---

## Phase 2: CVE-to-Rule Skill

Create the main skill for analyzing CVEs and generating rules.

### Directory Structure

```
.claude/skills/cve-to-rule/
├── SKILL.md                              # TODO - Main skill instructions
├── resources/
│   ├── semgrep-docs/                     # Phase 1 (above)
│   ├── semgrep-reference.md              # TODO - Quick reference
│   ├── existing-rules-summary.md         # TODO - Summary of custom-rules/
│   ├── cve-analysis-checklist.md         # TODO - Root cause analysis template
│   ├── false-positive-patterns.md        # TODO - Common FP sources
│   └── vulnerability-patterns/           # TODO - Per-vuln-type guides
│       ├── injection.md
│       ├── deserialization.md
│       ├── path-traversal.md
│       └── ssrf.md
├── examples/
│   ├── good-rules.md                     # TODO - High-quality examples
│   └── bad-rules.md                      # TODO - Anti-patterns
└── templates/
    ├── cve-rule-template.yaml            # TODO - Base CVE rule template
    └── test-file-template.py             # TODO - Test case template
```

### Skill Workflow (for SKILL.md)

1. **Input**: CVE ID or GitHub commit URL
2. **Fetch**: Get CVE details from OSV.dev/NVD, fetch patch diff
3. **Analyze**: Root cause analysis using checklist
4. **Check Coverage**: Search existing rules for overlap
5. **Generate**: Create rule using templates
6. **Validate**: Run `semgrep --validate`
7. **Output**: Save to `custom-rules/cve/CVE-XXXX-XXXX.yaml`

---

## Phase 3: Test-Semgrep-Rule Skill

Create skill for evaluating rules against known-vulnerable repositories.

### Directory Structure

```
.claude/skills/test-semgrep-rule/
├── SKILL.md                              # TODO - Main skill instructions
└── resources/
    ├── test-repositories.md              # TODO - Catalog of vulnerable repos
    ├── evaluation-criteria.md            # TODO - TP/FP definitions
    └── docker-commands.md                # TODO - Quick start commands
```

### Test Repository Catalog

| Language | Repository | Docker/Clone | Vuln Types |
|----------|------------|--------------|------------|
| Java | OWASP WebGoat | `docker run -p 8080:8080 webgoat/webgoat` | SQLi, XSS, XXE |
| Java | OWASP Benchmark | Clone + gradlew | Standardized metrics |
| PHP | DVWA | `docker run -p 80:80 vulnerables/web-dvwa` | SQLi, XSS, LFI |
| Node.js | OWASP Juice Shop | `docker run -p 3000:3000 bkimminich/juice-shop` | Modern JS |
| Python | Damn Vulnerable Python | Clone | Python-specific |
| Ruby | RailsGoat | Clone | Rails vulns |

### Evaluation Workflow

1. Clone/run vulnerable version of test repo
2. Run rule against vulnerable code → MUST detect
3. Checkout/run fixed version → MUST NOT detect
4. Run against OWASP Benchmark → measure FP rate
5. Generate evaluation report

---

## Phase 4: Update CVE Rule Workflow Document

Update `docs/cve-rule-workflow.md` with research-backed recommendations.

### Additions

| Section | Status | Content |
|---------|--------|---------|
| Three Variant Analysis Avenues | TODO | Pattern variants, insufficient patches, regressions |
| Rule Quality Gates | TODO | Rejection criteria from Autogrep research |
| Validation Protocol | TODO | Test against both vulnerable and fixed commits |
| Skill Integration | TODO | How to use `/cve-to-rule` and `/test-semgrep-rule` |

### Research Sources
- Autogrep (2025): https://lambdasec.github.io/AutoGrep-Automated-Generation-and-Filtering-of-Semgrep-Rules-from-Vulnerability-Patches/
- Semgrep Variant Analysis (2025): https://semgrep.dev/blog/2025/finding-more-zero-days-through-variant-analysis/
- OWASP Benchmark: https://owasp.org/www-project-benchmark/

---

## Phase 5: Existing Rules Summary

Create summary of all rules in `custom-rules/` for the skill to reference.

### File: `.claude/skills/cve-to-rule/resources/existing-rules-summary.md`

Content to generate:
- Count and list of rules per directory
- Vulnerability types covered
- Languages covered
- Key patterns to avoid duplicating

---

## Implementation Order

```
[x] 1. Create directory structure
[x] 2. Create rule-syntax.md (Phase 1)
[x] 3. Create pattern-syntax.md (Phase 1)
[x] 4. Create taint-mode.md (Phase 1)
[x] 5. Create testing-rules.md (Phase 1)
[x] 6. Create reducing-false-positives.md (Phase 1)
[x] 7. Create semgrep-reference.md - summarized quick ref (Phase 1)
[x] 8. Create existing-rules-summary.md (Phase 5)
[x] 9. Create cve-analysis-checklist.md (Phase 2)
[x] 10. Create false-positive-patterns.md (Phase 2)
[x] 11. Create vulnerability pattern guides (Phase 2)
[x] 12. Create rule examples (Phase 2)
[x] 13. Create cve-to-rule SKILL.md (Phase 2)
[x] 14. Create test-repositories.md (Phase 3)
[x] 15. Create evaluation-criteria.md (Phase 3)
[x] 16. Create test-semgrep-rule SKILL.md (Phase 3)
[x] 17. Update docs/cve-rule-workflow.md (Phase 4)
```

---

## Current Progress

**Last Updated**: 2025-12-23

**ALL PHASES COMPLETE**

### Phase 1: Semgrep Documentation ✓
All Semgrep documentation files created in `.claude/skills/cve-to-rule/resources/semgrep-docs/`:
- `rule-syntax.md` - Complete rule structure and operators
- `pattern-syntax.md` - Metavariables, ellipsis, pattern matching
- `taint-mode.md` - Sources, sinks, sanitizers, propagators
- `testing-rules.md` - Test annotations and validation protocol
- `reducing-false-positives.md` - FP reduction strategies
- `semgrep-reference.md` - Quick reference with links to full docs

### Phase 2: CVE-to-Rule Skill ✓
Complete skill created in `.claude/skills/cve-to-rule/`:
- `SKILL.md` - Main skill instructions
- `resources/existing-rules-summary.md` - Summary of 331 custom rules
- `resources/cve-analysis-checklist.md` - Root cause analysis template
- `resources/false-positive-patterns.md` - FP reduction catalog
- `resources/vulnerability-patterns/` - Per-vuln-type guides:
  - `injection.md` - SQL, command, code injection
  - `deserialization.md` - Pickle, YAML, Java serialization
  - `path-traversal.md` - File access vulnerabilities
  - `ssrf.md` - Server-side request forgery
- `examples/good-rules.md` - High-quality rule examples
- `examples/bad-rules.md` - Anti-patterns to avoid
- `templates/cve-rule-template.yaml` - Starting template
- `templates/test-file-template.py` - Test case template

### Phase 3: Test-Semgrep-Rule Skill ✓
Complete skill created in `.claude/skills/test-semgrep-rule/`:
- `SKILL.md` - Main skill instructions
- `resources/test-repositories.md` - Catalog of vulnerable apps
- `resources/evaluation-criteria.md` - TP/FP definitions and metrics
- `resources/docker-commands.md` - Quick start commands

### Phase 4: Workflow Document Update ✓
Updated `docs/cve-rule-workflow.md` with:
- Quick start using new skills
- Root cause analysis guidance
- Quality gates section (82% rejection rate research)
- Three avenues of variant hunting
- Skill integration section
- Research references (Autogrep, Semgrep blog)

**Notes**:
- Taint labels URL returned 404 - covered basics in taint-mode.md instead
- All 17 implementation steps completed
